MongoDBクエリ操作 逆引きリファレンス

# はじめに

ですので、今回は実際にmongoの中にデータが存在しているという想定で話をします。  
「こうゆうデータ取得したいなー」「こうゆう操作ってどうやってできるんだ？」のような事に直面をしている方を対象にしています。  
特に、実際の運用でも利用する機会が多いであろう検索・更新・削除に焦点を絞って話をしたいと思います。  


# 使用するデータ
今回、以下のようなデータを用意し、実際にこれらのデータを操作することで具体例を示していきたいと思います。
```
```

コレクションはstudentsとします。(コレクションとはRDBでいうテーブルに該当します。)  
具体のデータをローカルで実際に利用したいという人のために具体例データのスクリプトとその利用方法を[こちら](http://)にまとめておきました。  
また、Dockerを利用したmongodbのインストール&データ挿入の方法も併せて記載しておきましたので、mongoが手元にインストールされていなくてもDockerの環境がある方は利用してみてください。


# 基本的なコマンド
## 検索
### 基本構文
検索には`find`を利用します。条件をないにも記入しないと全件抽出されます。
```
db.コレクション名.find( { 条件 } )
```
### 具体例
`lastName`が`Tanaka`のレコードを表示する
```
db.students.find( { "lastName": "Suzuki" } )
```
## 更新
### 基本構文
mongoの場合、デフォルトでは条件に引っかかった一番初めのレコードしか更新されません。  
ですので、条件にあてはまる全てのレコードに対して更新を行いたい場合は`multi:true`を指定する必要があります。
```
db.コレクション名.update({ 条件 }, { 演算子: { 更新内容 } }, { multi: true } )
```
演算子はいくつかあるのですが、よく使用するものとしてはデータを更新する`$set`と、データを削除する`$unset`です。  

余談ですが、以下のコマンドも上と同意です。  
第3引数の`false`はupsert(データが存在していなければ`INSERT`, 存在すれば`UPDATE`)に対するオプション、第4引数の`true`は`multi`に関するオプションです。  
upsertはデフォルトで`false`なので、上記のようにmultiに関するオプションだけでよかったということです。  
他のページなどでは以下のコマンドを使用している場合があるので、混乱をしないように補足しておきました。
```
db.コレクション名.update({条件}, { 演算子 : {更新内容}}, false, true)
```

### 具体例
`lastName`が`Tanaka`のレコードの`age`を15から17に変更する
```
db.students.update( { "lastName": "Tanaka" }, { $set: { "age": 17 } } )
```
## 削除
### 基本構文
検索には`remove`を利用します。条件をないにも記入しないと全件削除されます。
```
db.コレクション名.remove( { 条件 } )
```

### 具体例
`lastName`が`Tanaka`のレコードを削除する
```
db.students.remove( { "lastName": "Tanaka" } )
```
## 件数取得
### 基本構文
検索には`count`を利用します。条件をないにも記入しないと全件数を取得できます。
```
db.コレクション名.count( { 条件 } )
```
もしくは`find`と併せることもできます。
```
db.コレクション名.find( { 条件 } ).count()
```
### 具体例
`students`コレクションに存在するレコード数を取得する
```
db.students.count()
```
`students`コレクションに存在するレコードのうち、`age`が15の件数を取得したい
```
db.students.find( { "age":15 } ).count()
```

# 覚えておくと役に立つコマンド
## ネストされたオブジェクトに対する処理
### 基本構文
`.`(ドット)を区切り記号として使用することでネストされたオブジェクトに対する操作をすることができます。
```
db.コレクション名.find(オブジェクト.ネストされたオブジェクト)
```

### 具体例
`body`の`height`が150のレコードを取得する
```
db.students.find( { "body.height": 150 } )
```

## 配列に対する更新
### 基本構文
オブジェクトが配列に存在する値を更新する場合は`.$.`のように結合する必要があります。  
先ほど説明したように、条件にあてはまる全てのレコードに対して更新を行いたい場合は`multi:true`を指定する必要があります。
```
db.コレクション名.update({ 条件 }, { 演算子: { オブジェクト.$.配列 } }, { multi: true } )
```

### 具体例
`lastName`が`Tanaka`のレコードに存在する、`grades`の`semester`が`first`のものに対して、`grade`を`95`に変更する。
```
db.students.update( { lastName: "Tanaka", "grades.semester": "first" }, { $set: { grades.$.grade: 95 } } )

```

## AND検索
### 基本構文
AND検索は条件を`,`(コロン)でつなげることで実現できます。
```
db.students.find({ 条件1, 条件2, ... })
```
### 具体例
`firstName`が`Jiro`, `lastName`が`Suzuki`のレコードを取得する
```
db.students.find( { "firstName": "Jiro", "lastName": "Suzuki" } )
```

## OR検索
### 基本構文
OR検索は`$or`演算子を利用することで実現できます。
```
db.students.find({ $or [ {or条件1}, {or条件2}, .... ] })
```
### 具体例
`lastName`が`Tanaka`もしくは`Suzuki`のレコードを取得する
```
db.students.find( { $or: [ {"lastName": "Tanaka"}, {"lastName": "Suzuki"} ] } )
```

## 部分一致検索
### 基本構文
部分一致検索は、条件を`//`で囲むことで実現できます。
```
db.students.find({ フィールド: /文字列/ })
```
### 具体例
`lastName`に`Ta`を含むレコードを取得する
```
db.students.find({ "lastName": /Ta/ })
```

## 「以上」「以下」検索
### 基本構文
「以上」「以下」といった検索条件は比較演算子を利用することで実現できます。  
`$gte`は「以上」、`$lte`は「以下」の検索ができます。(eを外すと「より大きい」「未満」になります。)  
```
db.コレクション名.find( { フィールド: { 比較演算子: 値 } } )
```
### 具体例
`height`が150以上の人を取り出す
```
db.students.find( { body.height: { $gte: 150 } } )
```
### 比較演算子一覧
比較演算子には具体例にあげたもの以外に`$ne`や`$exists`などもあり、まとめると以下のようになります。

|演算子|意味|クエリ例|
|:-|:-|:-|
|$lt|より小さい|{"age": {$lt: 15}}|
|$gt|より大きい|{"age": {$gt: 15}}|
|$lte|以上|{"age": {$lte: 15}}|
|$gte|以下|{"age": {$gte: 15}}|
|$ne|等しくない|{"age": {$ne: 15}}|
|$exists|フィールドの存在チェック|{"age": {$exists: true}}|
|$or|OR検索|{ $or: [ { "age": 15 }, { "age": 16} ] }|

## 時間の検索
### 基本構文


### 具体例

## 必要なところだけ表示
### 基本構文
上記の例からもわかるように、mongoのデータを検索すると全てのフィールドを出力することになります。自動で振られるidについては特に知りたいと思うことも少ないでしょうし、フィールド数が多くなると検索結果が分かりにくくなります。  
表示するフィールドの変更は`find`の第2引数で`1`と明記することで実現できます。  
逆に`-1`と明記するとそのフィールドは表示されません。
```
db.コレクション名.find({ 条件 },{ 表示したいフィールド: 1, ...})
```
### 具体例
`lastName`のみを出力させる。さらに`_id`は出力しないようにする。
```
db.students.find( { }, { "_id": -1, "lastName": 1 } )
```

## nullにアップデート
### 基本構文

### 具体例

# まとめ
今回は自分の体験をもとに検索・更新・削除に焦点を当てて、実際に運用で利用される機会が多いであろうコマンドについてまとめてみました。
「こういった場合はどうやってやればいいのか」とか「こういった操作もよく自分は利用している」など感想がありましたらコメントをいただければと思います。


====

update addToSet
update push
or検索
配列 $ninなど
$unset
`_id`を-1と明記しなくてもlastNameだけ表示させられるのか？
.$.もmuti:trueにしないといけないのか？
同様の方法で更新や削除も行うことができます。
$exist
unset
