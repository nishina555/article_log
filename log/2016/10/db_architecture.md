テーブル設計手順

# はじめに
- 作りたいシステムの概要をもとに要件を定義し、要件を満たすようなRDBを設計する
- アンチパターンなども説明する

# 設計の概要
- 概念スキーマ（論理設計）→内部スキーマ（物理設計）の順で設計が進む p29
- エンティティ、リレーション(テーブル同士に線を結ぶ)、属性（エンティティになにがあるか）、関連の多重度の流れ（1:多など）

#　概念スキーマ(論理設計)
## エンティティの抽出
- 分解できるところまで分解する。一つのカラムでカンマ区切りで複数データもつのは分解が足りていない証拠。
- 列で子を持っているのも分解足りていない証拠
- 物理的実体を含んでいなくてもいい
- 正規化をする中でより見えてくるものがあるので、まずは出せるところからでいい。
## エンティティの定義
- キーはなにか？
- どういった属性が含まれているか？
## テーブル(=エンティティ)定義
### テーブルについて
- テーブルとは共通点を持ったレコード p70
- テーブル名は英語ならば複数形/複数名詞で書ける。そうでなければそのテーブルのどこかに間違いがある。
- テーブルの列の制約。アンダーバーを利用する。最初はアルファベット
- 全てのテーブルにid列を用いる安易な考えはしてはいけない p42
### キーについて
- 名前をキーに使う、可変長文字列(VARCHAR)を使うのはアンチパターン p214
- 値の変わる列を主キーや外部キーにするとよくない
- キーとなる列にはコードやIDなど表記体系の定まった固定長文字列を利用する p78
- 固定長文字列のコード列がキーには向いている
### 主キーについて
- 主キーはNULLを含んではいけない
- 主キーはidという名前を避ける（アンチパターン)
### 外部キーについて
- 外部キーは人間の親子関係と同じ。子から削除をする。親(1)、子(多。子テーブルにFKが存在する。親に存在しない値は子のテーブルで作成できない。＝参照整合性制約) p77。外部キー制約を利用しないのはアンチパターン。もし外部キー制約をつけないと列を削除するときに子テーブルも正しく更新できるかなど考える必要がある。 p44
- 子に対して複数の親がいるときは設計が間違っている可能性あり(ポリモーフィック)
  - 共通テーブル or 交差テーブルを利用する。
- 参照整合性制約は重要。別にレスポンス遅くならない(TODO: なんで参照整合性制約嫌うんだっけ?たしか柔軟に削除できない（絶対子から削除する）とか、アップデートが基本できないからだった気がする。)


## 正規化
- 一つのカラムに一つの要素を入れるのが第一正規形だけど、カンマ区切りのフォーマットで格納するのはアンチパターン（一つのカラムに要素を詰め込んでしまうケース）
- 部分関数従属になるキーと従属列を独立のテーブルにすると第二正 規形 p93
- 主キーによって一意にレコードが定まるか確認。
- 複合キーの場合、主キーの一部で一意に定まってしまわないか確認。つまり複合キーでようやく一意に定まることを確認。
- 関数従属をチェックするのが正規化を進めるポイント

## ER図の作成
- あるテーブルの主キーが他のテーブルに列として含まれるか着目 p126
- 1:1というテーブルはできないので、そのようなものがある場合正規化が間違ってる
- 多：多になるなら中間テーブルを作成する。
- 主キーが決まらなければ代理キーで。代理キーはDB側で用意されているオートナンバリングで実装するのがいい。



# 内部スキーマ(物理設計)
## テーブル定義
## インデックス定義
## ハードウェアのサイジング
## ストレージの冗長構成決定
## ファイルの物理配置決定


# アンチパターンなど
## とりあえずid
全てのテーブルにid列を用いる安易な考えはしてはいけない p42
## 信号無視
カンマ区切りのフォーマットで格納する（一つのカラムに要素を詰め込んでしまうケース）
- 交差テーブルなどを利用する
## ポリモーフィック関連（複数のテーブルを参照する）
親が二つあって、子のテーブルにある外部キーがどちらかの親に属しているというようなパターン。参照制約つかえなくなるし、JOINすると片方の親はNULLになる。
- 本来の関連が逆になっている可能性があるので参照を逆にする
- 共通テーブルを作成する。
- 交差テーブルを作成する。
## マルチカラムアトリビュート
列持ちテーブルのこと
- 従属テーブルを新たに作る
- グレーゾーン
- 第一正規形（列持ちを従属テーブルに切り離すと第二正規形になって、結果的に行持ちの形になる（多分）
## その他
- 名前をキーに使う、可変長文字列(VARCHAR)を使う p214
- 値の変わる列を主キーや外部キーにするとよくない

# その他のアンチパターン
だいたいのアンチパターンは正規化などの間で解消されるが、説明できなかったもの。
以下のようなER図が存在していたら設計を疑うべし。
## ダブルミーニング(カラムの意味がレコードで変わる)
## 単一参照テーブル（ダムルミーニングの応用。複数の構造が似てるテーブルをくっつけるやつ）
## 水平分割
- パーティションで解決できる
## ポリモーフィック
- 子に対して親が複数いるケースのことをいう。
- 親子関係と外部キー制約のところで話ができると思う。

# グレーゾーン
## 列持ちテーブル



＝＝＝＝＝
複合キーでいいの？どっかで単一キーのほうが主キーには向いてるって聞いた気がする。
